"Male"   = "m"))
kilifi_set<-kilifi_set %>% mutate(pw = pop/sum(pop)) %>% select(agecat, sex, pop, pw)
kilifi_set <- kilifi_set %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
kilifi_data <-Kilifidata %>%
mutate(agecat = case_when(
age_y >= 0 & age_y < 5 ~ "<5",
age_y >= 5 & age_y <15 ~ "5-14",
age_y >= 15 & age_y<45 ~ "15-44",
age_y >= 45 & age_y <65 ~ "45-64",
age_y >= 65 ~ "65+",
TRUE ~ NA_character_
))
kilifi_data <- kilifi_data %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
kilifi_data<- kilifi_data %>% select(agecat, sex, chke1_pos,denv_pos,rvfgc_pos)
kilifi_counts <-
kilifi_data %>%
group_by(sex, agecat, .drop = FALSE) %>%
summarise(y = sum(chke1_pos), n = n()) %>%
mutate(n=ifelse(is.na(y),1,n), # replacing values in the n strata with no data with 0
y=ifelse(is.na(y),0,y))
kilifi_data <- kilifi_counts %>%
left_join(kilifi_set, by = c("sex", "agecat"))
kilifi_pw <-
kilifi_data %>%
group_by(sex, agecat,.drop = FALSE) %>%
summarise(pw = mean(pw))
y <- array(kilifi_counts$y, dim = c(5, 2))
n <- array(kilifi_counts$n, dim = c(5, 2))
pw <- array(kilifi_pw$pw, dim = c(5, 2))
tot_pw_age <- rowSums(pw, dims = 1)
tot_pw_sex <- colSums(pw)
#Manyatta
manyatta_set <- manyatta_pop_data %>% select(age_group,Sex, N_mid2022)
manyatta_set <- manyatta_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
manyatta_set$pop<- as.numeric(manyatta_set$pop)
manyatta_set<-manyatta_set %>% mutate(pw = pop/sum(pop)) %>% select(agecat, sex, pop, pw)
manyatta_set <- manyatta_set %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
manyatta_data <-manyattadata_clean %>%
mutate(agecat = case_when(
ageyrs >= 0 & ageyrs < 5 ~ "<5",
ageyrs >= 5 & ageyrs <15 ~ "5-14",
ageyrs >= 15 & ageyrs <45 ~ "15-44",
ageyrs >= 45 & ageyrs <65 ~ "45-64",
ageyrs >= 65 ~ "65+",
TRUE ~ NA_character_
))
manyatta_data <- manyatta_data %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
manyatta_counts <-
manyatta_data %>%
group_by(sex, agecat, .drop = FALSE) %>%
summarise(y = sum(CHKpos), n = n()) %>%
mutate(n=ifelse(is.na(y),1,n), # replacing values in the n strata with no data with 0
y=ifelse(is.na(y),0,y)) %>% select(agecat, sex, y, n)
manyatta_counts <- manyatta_counts %>%
mutate(
sex = ifelse(sex == "F", "Female",
ifelse(sex == "M", "Male", sex))
)
manyatta_data <- manyatta_counts %>%
left_join(manyatta_set, by = c("sex", "agecat"))
manyatta_data$sex<-as.factor(manyatta_data$sex)
manyatta_data$agecat<-as.factor(manyatta_data$agecat)
manyatta_pw <-
manyatta_data %>%
group_by(sex, agecat,.drop = FALSE) %>%
summarise(pw = mean(pw))
y <- array(manyatta_counts$y, dim = c(5, 2))
n <- array(manyatta_counts$n, dim = c(5, 2))
pw <- array(manyatta_pw$pw, dim = c(5, 2))
tot_pw_age <- rowSums(pw, dims = 1)
tot_pw_sex <- colSums(pw)
#Kibera
kibera_set <- kibera_pop_data %>% select(age_group,Sex, N_mid2022)
kibera_set <- kibera_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
kibera_set$pop<- as.numeric(kibera_set$pop)
kibera_set <- kibera_set %>%
mutate(sex = recode(sex,
"Female" = "F",
"Male"   = "M"))
kibera_set<-kibera_set %>% mutate(pw = pop/sum(pop)) %>% select(agecat, sex, pop, pw)
kibera_set <- kibera_set %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
kibera_data <-Kiberadata %>%
mutate(agecat = case_when(
ageyrs >= 0 & ageyrs < 5 ~ "<5",
ageyrs >= 5 & ageyrs <15 ~ "5-14",
ageyrs >= 15 & ageyrs <45 ~ "15-44",
ageyrs >= 45 & ageyrs <65 ~ "45-64",
ageyrs >= 65 ~ "65+",
TRUE ~ NA_character_
))
kibera_data<- kibera_data %>% select(agecat, sex, chke1_pos,denv_pos,rvfgc_pos)
kibera_data <- kibera_data %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
kibera_counts <-
kibera_data %>%
group_by(sex, agecat, .drop = FALSE) %>%
summarise(y = sum(chke1_pos), n = n()) %>%
mutate(n=ifelse(is.na(y),1,n),
y=ifelse(is.na(y),0,y))
kibera_counts$sex<-as.factor(kibera_counts$sex)
kibera_counts$agecat<-as.factor(kibera_counts$agecat)
kibera_data <-kibera_counts %>%
left_join(kibera_set, by = c("sex", "agecat"))
kibera_pw <-
kibera_data %>%
group_by(sex, agecat,.drop = FALSE) %>%
summarise(pw = mean(pw))
y <- array(kibera_counts$y, dim = c(5, 2))
n <- array(kibera_counts$n, dim = c(5, 2))
pw <- array(kibera_pw$pw, dim = c(5, 2))
tot_pw_age <- rowSums(pw, dims = 1)
tot_pw_sex <- colSums(pw)
#combined data
nrb_set <- nairobi_pop_data %>% select(Ageband,Sex, N_mid2022, age_group)
nrb_set <- nrb_set %>% rename(agecat = age_group, pop = N_mid2022,sex = Sex)
nrb_set$pop<- as.numeric(nrb_set$pop)
nrb_set$site<- "NAIROBI"
nrb_set<- nrb_set %>% select(agecat,sex, pop, site)
asembo_set <- asembo_pop_data %>% select(age_group,Sex, N_mid2022)
asembo_set <- asembo_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
asembo_set$pop<- as.numeric(asembo_set$pop)
asembo_set$site<- "ASEMBO"
kilifi_set <- kilifi_pop_data %>% select(age_group,Sex, N_mid2022)
kilifi_set <- kilifi_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
kilifi_set$pop<- as.numeric(kilifi_set$pop)
kilifi_set$site<- "KILIFI"
manyatta_set <- manyatta_pop_data %>% select(age_group,Sex, N_mid2022)
manyatta_set <- manyatta_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
manyatta_set$pop<- as.numeric(manyatta_set$pop)
manyatta_set$site<- "MANYATTA"
kibera_set <- kibera_pop_data %>% select(age_group,Sex, N_mid2022)
kibera_set <- kibera_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
kibera_set$pop<- as.numeric(kibera_set$pop)
kibera_set$site<- "Kibera"
df_set <- rbind(asembo_set, manyatta_set, kilifi_set, kibera_set, nrb_set)
df_set<-df_set %>% mutate(pw = pop/sum(pop)) %>% select(site,agecat, sex, pop, pw)
df_set <- df_set %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
df_set$sex<- as.character(df_set$sex)
df_set<- df_set %>% select(agecat,sex,site, pop, pw)
df_data <-df_all %>%
mutate(agecat = case_when(
ageyrs >= 0 & ageyrs < 5 ~ "<5",
ageyrs >= 5 & ageyrs <15 ~ "5-14",
ageyrs >= 15 & ageyrs <45 ~ "15-44",
ageyrs >= 45 & ageyrs <65 ~ "45-64",
ageyrs >= 65 ~ "65+",
TRUE ~ NA_character_
))
df_data$CHKpos<- as.numeric(df_data$CHKpos)
df_data <- df_data %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat) %>% select(agecat, sex, site, CHKpos,DENpos,RVFpos)
df_data<- df_data %>% mutate(CHKpos= ifelse(CHKpos==1,1,0))
df_data<- df_data %>% mutate(DENpos= ifelse(DENpos==1,1,0))
df_data$CHKpos<- as.numeric(df_data$CHKpos)
df_data$DENpos<- as.numeric(df_data$DENpos)
df_counts <-
df_data %>%
group_by(sex, agecat,site, .drop = FALSE) %>%
summarise(y = sum(DENpos), n = n()) %>%
mutate(n=ifelse(is.na(y),1,n), # replacing values in the n strata with no data with 0
y=ifelse(is.na(y),0,y))
df_counts<- df_counts %>% select(agecat,sex, site, y, n)
df_counts$sex<- as.factor(df_counts$sex)
df_counts$agecat<- as.factor(df_counts$agecat)
df_counts$site<- as.factor(df_counts$site)
df_data <- df_set %>%
left_join(df_counts, by = c( "agecat", "sex", "site"))
df_pw <-
df_data %>%
group_by(sex, agecat,site, .drop = FALSE) %>%
summarise(pw = mean(pw))
y <- array(df_counts$y, dim = c(5, 2,5))
n <- array(kibera_counts$n, dim = c(5, 2,5))
pw <- array(kibera_pw$pw, dim = c(5, 2,5))
tot_pw_age <- rowSums(pw, dims = 1)
tot_pw_sex <- colSums(pw)
y <- array(df_counts$y, dim = c(5, 2, 5))
n <- array(df_counts$n, dim = c(5, 2, 5))
pw <- array(df_pw$pw, dim = c(5, 2, 5))
tot_pw_age <- apply(pw, 1, sum)
tot_pw_sex <- apply(pw, 2, sum)
tot_pw_region <- apply(pw, 3, sum)
x <- 74
N_se <- 67
z <- 82
N_sp <- 90
mrp_adjusted_region <- "
data {
int N_se;
int N_sp;
int x;
int z;
int y[5, 2, 5];
int n[5, 2, 5];
real pw[5, 2, 5];
real tot_pw_age[5];
real tot_pw_sex[2];
real tot_pw_region[5];
}
parameters {
real<lower=0,upper=1> se;
real<lower=0,upper=1> sp;
real bsex[2];
real bage[5];
real bregion[5];
real<lower=0> sd_age;
real<lower=0> sd_region;
}
transformed parameters {
real<lower=0,upper=1> p[5, 2, 5];
real<lower=0,upper=1> p_obs[5, 2, 5];
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p[a, s, r] = inv_logit(bage[a] + bsex[s] + bregion[r]);
p_obs[a, s, r] = se * p[a, s, r] + (1 - sp) * (1 - p[a, s, r]);
}
}
}
}
model {
// Priors
se ~ beta(67.3,5.1);
sp ~ beta(88.6,9.6);
bsex ~ normal(0, 1);
bage ~ normal(0, sd_age);
bregion ~ normal(0, sd_region);
sd_age ~ normal(0, 0.25);
sd_region ~ normal(0, 0.25);
// Likelihood
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
y[a, s, r] ~ binomial(n[a, s, r], p_obs[a, s, r]);
}
}
}
x ~ binomial(N_se, se);
z ~ binomial(N_sp, sp);
}
generated quantities {
real p_national = 0;
vector[5] p_age = rep_vector(0, 5);
vector[2] p_sex = rep_vector(0, 2);
vector[5] p_region = rep_vector(0, 5);
// National prevalence
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p_national += p[a, s, r] * pw[a, s, r];
}
}
}
// Regional prevalence
for(r in 1:5){
for(a in 1:5){
for(s in 1:2){
p_region[r] += p[a, s, r] * pw[a, s, r] / tot_pw_region[r];
}
}
}
// Age-specific prevalence
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p_age[a] += p[a, s, r] * pw[a, s, r] / tot_pw_age[a];
}
}
}
// Sex-specific prevalence
for(s in 1:2){
for(a in 1:5){
for(r in 1:5){
p_sex[s] += p[a, s, r] * pw[a, s, r] / tot_pw_sex[s];
}
}
}
}
"
mrp_model <- stan_model(model_code = mrp_adjusted_region)
fit <- sampling(
object = mrp_model,
data = list(
y = y,
n = n,
pw = pw,
tot_pw_age = tot_pw_age,
tot_pw_sex = tot_pw_sex,
tot_pw_region = tot_pw_region,
x = x,
z = z,
N_se = N_se,
N_sp = N_sp
),
chains = 3,
warmup = 1000,
iter = 10000,
cores = 3,
seed = 111,
pars = c("bage","bsex","bregion","sd_age","sd_region","p_age","p_sex","p_region","p_national","se","sp"),
refresh = 0
)
View(tot_pw_age)
View(df_counts)
#combined data
nrb_set <- nairobi_pop_data %>% select(Ageband,Sex, N_mid2022, age_group)
nrb_set <- nrb_set %>% rename(agecat = age_group, pop = N_mid2022,sex = Sex)
nrb_set$pop<- as.numeric(nrb_set$pop)
nrb_set$site<- "NAIROBI"
nrb_set<- nrb_set %>% select(agecat,sex, pop, site)
asembo_set <- asembo_pop_data %>% select(age_group,Sex, N_mid2022)
asembo_set <- asembo_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
asembo_set$pop<- as.numeric(asembo_set$pop)
asembo_set$site<- "ASEMBO"
kilifi_set <- kilifi_pop_data %>% select(age_group,Sex, N_mid2022)
kilifi_set <- kilifi_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
kilifi_set$pop<- as.numeric(kilifi_set$pop)
kilifi_set$site<- "KILIFI"
manyatta_set <- manyatta_pop_data %>% select(age_group,Sex, N_mid2022)
manyatta_set <- manyatta_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
manyatta_set$pop<- as.numeric(manyatta_set$pop)
manyatta_set$site<- "MANYATTA"
kibera_set <- kibera_pop_data %>% select(age_group,Sex, N_mid2022)
kibera_set <- kibera_set %>% rename(agecat = age_group,sex = Sex, pop = N_mid2022)
kibera_set$pop<- as.numeric(kibera_set$pop)
kibera_set$site<- "Kibera"
df_set <- rbind(asembo_set, manyatta_set, kilifi_set, kibera_set, nrb_set)
df_set<-df_set %>% mutate(pw = pop/sum(pop)) %>% select(site,agecat, sex, pop, pw)
df_set <- df_set %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat)
df_set$sex<- as.character(df_set$sex)
df_set<- df_set %>% select(agecat,sex,site, pop, pw)
df_data <-df_all %>%
mutate(agecat = case_when(
ageyrs >= 0 & ageyrs < 5 ~ "<5",
ageyrs >= 5 & ageyrs <15 ~ "5-14",
ageyrs >= 15 & ageyrs <45 ~ "15-44",
ageyrs >= 45 & ageyrs <65 ~ "45-64",
ageyrs >= 65 ~ "65+",
TRUE ~ NA_character_
))
df_data$CHKpos<- as.numeric(df_data$CHKpos)
df_data <- df_data %>%
mutate(agecat = factor(agecat, levels = c("<5", "5-14", "15-44", "45-64", "65+"))) %>%
arrange(agecat) %>% select(agecat, sex, site, CHKpos,DENpos,RVFpos)
df_data<- df_data %>% mutate(CHKpos= ifelse(CHKpos==1,1,0))
df_data<- df_data %>% mutate(DENpos= ifelse(DENpos==1,1,0))
df_data$CHKpos<- as.numeric(df_data$CHKpos)
df_data$DENpos<- as.numeric(df_data$DENpos)
df_counts <-
df_data %>%
group_by(sex, agecat,site, .drop = FALSE) %>%
summarise(y = sum(DENpos), n = n()) %>%
mutate(n=ifelse(is.na(y),1,n), # replacing values in the n strata with no data with 0
y=ifelse(is.na(y),0,y))
df_counts<- df_counts %>% select(agecat,sex, site, y, n)
df_counts$sex<- as.factor(df_counts$sex)
df_counts$agecat<- as.factor(df_counts$agecat)
df_counts$site<- as.factor(df_counts$site)
df_data <- df_set %>%
left_join(df_counts, by = c( "agecat", "sex", "site"))
y <- array(df_counts$y, dim = c(5, 2, 5))
n <- array(df_counts$n, dim = c(5, 2, 5))
pw <- array(df_pw$pw, dim = c(5, 2, 5))
tot_pw_age <- apply(pw, 1, sum)
tot_pw_sex <- apply(pw, 2, sum)
tot_pw_region <- apply(pw, 3, sum)
x <- 74
N_se <- 67
z <- 82
N_sp <- 90
mrp_adjusted_region <- "
data {
int N_se;
int N_sp;
int x;
int z;
int y[5, 2, 5];
int n[5, 2, 5];
real pw[5, 2, 5];
real tot_pw_age[5];
real tot_pw_sex[2];
real tot_pw_region[5];
}
parameters {
real<lower=0,upper=1> se;
real<lower=0,upper=1> sp;
real bsex[2];
real bage[5];
real bregion[5];
real<lower=0> sd_age;
real<lower=0> sd_region;
}
transformed parameters {
real<lower=0,upper=1> p[5, 2, 5];
real<lower=0,upper=1> p_obs[5, 2, 5];
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p[a, s, r] = inv_logit(bage[a] + bsex[s] + bregion[r]);
p_obs[a, s, r] = se * p[a, s, r] + (1 - sp) * (1 - p[a, s, r]);
}
}
}
}
model {
// Priors
se ~ beta(67.3,5.1);
sp ~ beta(88.6,9.6);
bsex ~ normal(0, 1);
bage ~ normal(0, sd_age);
bregion ~ normal(0, sd_region);
sd_age ~ normal(0, 1);
sd_region ~ normal(0, 1);
// Likelihood
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
y[a, s, r] ~ binomial(n[a, s, r], p_obs[a, s, r]);
}
}
}
x ~ binomial(N_se, se);
z ~ binomial(N_sp, sp);
}
generated quantities {
real p_national = 0;
vector[5] p_age = rep_vector(0, 5);
vector[2] p_sex = rep_vector(0, 2);
vector[5] p_region = rep_vector(0, 5);
// National prevalence
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p_national += p[a, s, r] * pw[a, s, r];
}
}
}
// Regional prevalence
for(r in 1:5){
for(a in 1:5){
for(s in 1:2){
p_region[r] += p[a, s, r] * pw[a, s, r] / tot_pw_region[r];
}
}
}
// Age-specific prevalence
for(a in 1:5){
for(s in 1:2){
for(r in 1:5){
p_age[a] += p[a, s, r] * pw[a, s, r] / tot_pw_age[a];
}
}
}
// Sex-specific prevalence
for(s in 1:2){
for(a in 1:5){
for(r in 1:5){
p_sex[s] += p[a, s, r] * pw[a, s, r] / tot_pw_sex[s];
}
}
}
}
"
mrp_model <- stan_model(model_code = mrp_adjusted_region)
fit <- sampling(
object = mrp_model,
data = list(
y = y,
n = n,
pw = pw,
tot_pw_age = tot_pw_age,
tot_pw_sex = tot_pw_sex,
tot_pw_region = tot_pw_region,
x = x,
z = z,
N_se = N_se,
N_sp = N_sp
),
chains = 3,
warmup = 1000,
iter = 10000,
cores = 3,
seed = 111,
pars = c("bage","bsex","bregion","sd_age","sd_region","p_age","p_sex","p_region","p_national","se","sp"),
refresh = 0
)
y <- array(df_counts$y, dim = c(5, 2, 5))
n <- array(df_counts$n, dim = c(5, 2, 5))
pw <- array(df_pw$pw, dim = c(5, 2, 5))
tot_pw_age <- apply(pw, 1, sum)
tot_pw_sex <- apply(pw, 2, sum)
tot_pw_region <- apply(pw, 3, sum)
x <- 74
N_se <- 67
z <- 82
N_sp <- 90
